---
tags:
  - Программирование
  - вебИнструменты
  - Nginx
---
# Nginx

## Основные принципы работы

Nginx (произносится как "engine-x") — это высокопроизводительный **веб-сервер**, **обратный прокси-сервер**, **кэширующий сервер** и **балансировщик нагрузки**. Его архитектура принципиально отличается от классических серверов (как Apache) и основана на асинхронной, событийно-ориентированной модели обработки запросов, что позволяет ему эффективно работать с десятками тысяч одновременных соединений.

### Асинхронная модель (Event-Driven)

```plaintext
Nginx Master Process
        |
        |---> Worker Process 1 (обрабатывает соединения A, C, E...)
        |---> Worker Process 2 (обрабатывает соединения B, D, F...)
        |
        |--- Каждый Worker использует неблокирующий I/O
        |--- и обрабатывает тысячи соединений параллельно в одном потоке.
```

В отличие от традиционной модели "один поток на соединение" (thread-per-connection), где каждое новое соединение создает нагрузку на систему, Nginx использует фиксированное количество рабочих процессов (worker processes). Каждый рабочий процесс обрабатывает множество соединений асинхронно, не блокируясь на операциях ввода-вывода (например, чтении файла с диска или ожидании ответа от бэкенд-сервера). Это делает Nginx чрезвычайно экономичным с точки потребления ресурсов (CPU и RAM).

### Обработка HTTP-запроса

```plaintext
Клиент                          Nginx                         Бэкенд-сервер (Go-приложение)
  |                               |                               |
  | ------ HTTP Request --------> |                               |
  |                               |                               |
  |                               | -- (если нужен бэкенд) -->    |
  |                               | <- HTTP Response от бэкенда - |
  |                               |                               |
  | <----- HTTP Response ---------|                               |
```

Когда Nginx получает запрос, он следует конфигурации, чтобы определить, как его обработать:
1. **Отдать статический файл** (например, .html, .css, .js, изображения) напрямую с диска.
2. **Проксировать запрос** на бэкенд-сервер (например, на ваше Go-приложение, работающее на порту 8080).
3. **Вернуть кэшированный ответ**, если он есть в кэше Nginx.

## Архитектура и конфигурация

### Структура процессов

Nginx запускается с помощью главного процесса (Master Process), который работает от имени root (если нужно биндиться на порты ниже 1024, например, 80/443). Его задачи:
- Чтение и валидация конфигурации.
- Управление рабочими процессами (Worker Processes).
- Перезагрузка конфигурации без простоя (`nginx -s reload`).

Рабочие процессы (Worker Processes) — это те, кто непосредственно обрабатывает запросы. Они работают от непривилегированного пользователя (например, `www-data` или `nginx`) для безопасности.

### Базовая структура конфигурационного файла (`nginx.conf`)

Конфигурация строится на **директивах** и **контекстах**.

```nginx
# Главный контекст (настройки всего сервера)
user www-data;
worker_processes auto; # Количество worker'ов = числу CPU ядер

events {
    worker_connections 1024; # Макс. число соединений на worker
}

http {
    # Контекст HTTP (настройки для HTTP-трафика)
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Определение upstream-группы бэкендов (для балансировки нагрузки)
    upstream my_go_app {
        server localhost:8080; # Ваше Go-приложение
        server localhost:8081 backup; # Резервный сервер
    }

    # Виртуальный хост (серверный блок)
    server {
        listen 80;
        server_name example.com;

        # Обработка статических файлов
        location /static/ {
            alias /var/www/static/;
            expires 30d; # Кэширование в браузере
        }

        # Проксирование всех остальных запросов на Go-приложение
        location / {
            proxy_pass http://my_go_app; # Ссылка на upstream
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
```

## Ключевые функции и зачем они нужны

### 1. Веб-сервер для статического контента
Nginx невероятно эффективен в отдаче статических файлов (HTML, CSS, JS, изображения, видео). Он тратит на это значительно меньше ресурсов, чем бэкенд-приложение на Go. Поэтому статику всегда стоит отдавать через Nginx.

**Зачем это нужно?**
- Разгружает ваше бэкенд-приложение.
- Значительно увеличивает скорость отдачи статики.

### 2. Обратный прокси (Reverse Proxy)
Это основная причина использования Nginx вместе с бэкенд-приложениями. Nginx принимает запросы извне (от клиентов) и "проксирует" их на одно или несколько внутренних приложений.

**Зачем это нужно?**
- **Сокрытие внутренней структуры:** Клиенты не знают, на каком порту и сколько у вас бэкенд-серверов.
- **Едильная точка входа:** Можно запускать несколько бэкенд-приложений на разных портах, а снаружи будет один домен и порт (80/443).
- **Терминация SSL:** Nginx может принимать HTTPS-трафик, расшифровывать его и передавать на бэкенд уже простой HTTP-запрос. Это избавляет бэкенд-приложение от необходимости заниматься шифрованием.

### 3. Балансировщик нагрузки (Load Balancer)
Если ваше Go-приложение не справляется с нагрузкой, вы можете запустить несколько его экземпляров (инстансов), а Nginx будет распределять запросы между ними.

```nginx
upstream backend {
    server 10.0.1.10:8080 weight=3; # У этого сервера больше "веса"
    server 10.0.1.11:8080;
    server 10.0.1.12:8080;
}
```
**Алгоритмы балансировки:** round-robin, least-connected, ip-hash (для сохранения сессии).

**Зачем это нужно?**
- **Масштабируемость:** Легко добавить еще один сервер для обработки возросшей нагрузки.
- **Отказоустойчивость:** Если один из бэкендов "падает", Nginx перестает слать на него запросы до момента восстановления.

### 4. Кэширование
Nginx может кэшировать ответы от бэкенд-приложений. Если два пользователя запрашивают одну и ту же страницу, Nginx отдаст кэшированную копию второму пользователю, не обращаясь к бэкенду.

**Зачем это нужно?**
- **Снижение нагрузки:** Резко уменьшает количество запросов к вашему Go-приложению.
- **Увеличение скорости ответа:** Отдача кэшированного ответа происходит почти мгновенно.

## Применение в современных системах

Nginx является стандартом де-факто в веб-разработке и используется как:
- **Фронтенд-сервер** для приложений на Go, Python (Django/Flask), Node.js, Ruby on Rails и др.
- **Балансировщик нагрузки** в микросервисных архитектурах.
- **Кэширующий прокси** для ускорения работы сайтов.
- **Терминатор SSL/TLS** для централизованного управления сертификатами (часто в связке с Let's Encrypt).

Понимание работы Nginx критически важно для бэкенд-разработчика, так как в 99% случаев ваше приложение будет работать за ним, а не напрямую взаимодействовать с интернетом.