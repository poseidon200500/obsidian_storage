---
tags:
  - Программирование
---
### **Строки в Go: полное руководство**

---

#### **1. Внутреннее устройство строк**
Строка в Go — это **неизменяемая** последовательность байт с автоматической поддержкой UTF-8.

**Физическое представление:**
```go
type stringStruct struct {
    str unsafe.Pointer // указатель на массив байт
    len int           // длина в байтах
}
```
- **Неизменяемость**: При "изменении" создается новая строка
- **UTF-8 по умолчанию**: Без BOM (Byte Order Mark)
- **Нулевое значение**: `""` (пустая строка, не `nil`)

**Пример в памяти:**
```
Строка "Привет" (12 байт):
+---+---+---+---+---+---+---+---+---+---+---+---+
| D0 | 9F | D1 | 80 | D0 | B8 | D0 | B2 | D0 | B5 | D1 | 82 |
+---+---+---+---+---+---+---+---+---+---+---+---+
```

---

#### **2. Создание и базовые операции**
**Инициализация:**
```go
s1 := "строка"
s2 := `raw\nstring` // сырая строка (без экранирования)
s3 := string([]byte{65, 66, 67}) // "ABC" (из байтов)
```

**Конкатенация:**
```go
// НЕЭФФЕКТИВНО (создает новые строки):
result := ""
for i := 0; i < 1000; i++ {
    result += "a" // О(n²) операций!
}

// ЭФФЕКТИВНО:
var builder strings.Builder
for i := 0; i < 1000; i++ {
    builder.WriteString("a") // O(n)
}
result := builder.String()
```

**Длина строки:**
```go
len("Привет") // 12 байт (не символов!)
utf8.RuneCountInString("Привет") // 6 символов
```

---

#### **3. Итерация по строке**
**По байтам:**
```go
for i := 0; i < len(s); i++ {
    byte := s[i] // uint8
}
```

**По символам (рунам):**
```go
for idx, runeValue := range s {
    fmt.Printf("%#U starts at %d\n", runeValue, idx)
}
```

**Пример разбора:**
```go
s := "日本語"
for i, r := range s {
    fmt.Printf("%d: %q (0x%x)\n", i, r, r)
}
/*
0: '日' (0x65e5)
3: '本' (0x672c)
6: '語' (0x8a9e)
*/
```

---

#### **4. Пакет `strings`: ключевые методы**
**Поиск:**
```go
strings.Contains("hello", "ell")   // true
strings.Index("hello", "l")       // 2
strings.LastIndex("hello", "l")   // 3
strings.HasPrefix("http://", "http") // true
```

**Модификация:**
```go
strings.ToUpper("hello")          // "HELLO"
strings.TrimSpace("  text  ")     // "text"
strings.Replace("oink", "o", "0", -1) // "00ink"
```

**Разделение/объединение:**
```go
strings.Split("a,b,c", ",")      // ["a","b","c"]
strings.Join([]string{"a","b"}, "-") // "a-b"
```

**Буферизация:**
```go
builder := strings.Builder{}
builder.Grow(100) // Предварительное выделение
builder.WriteString("Hello")
builder.WriteByte('!')
result := builder.String() // "Hello!"
```

---

#### **5. Пакет `strconv`: конвертация**
**Числа ↔ Строки:**
```go
strconv.Itoa(123)         // "123"
strconv.Atoi("456")       // 456, <nil>
strconv.ParseFloat("3.14", 64) // 3.14, <nil>
```

**Форматирование:**
```go
strconv.FormatInt(255, 16) // "ff"
strconv.Quote("Hello")     // `"Hello"` (с кавычками)
```

---

#### **6. Оптимизация производительности**
**Паттерны:**
1. **Избегайте частой конкатенации `+`**  
   Используйте `strings.Builder` для >5 операций.

2. **Преобразование ↔ `[]byte`**  
   ```go
   // Быстрое преобразование (без аллокации):
   func StringToBytes(s string) []byte {
       return *(*[]byte)(unsafe.Pointer(&s))
   }
   ```

3. **Кеширование длинных строк**  
   Глобальные константы вместо повторного создания.

**Бенчмарк конкатенации:**
```
+ оператор (1000 итераций):   5241 ns/op
strings.Builder (1000 итер.): 361 ns/op
```

---

#### **7. Работа с UTF-8**
**Основные функции:**
```go
utf8.ValidString("привет")      // true
utf8.RuneLen('日')              // 3
utf8.DecodeRuneInString("日")   // '日', 3
```

**Нормализация (пакет `golang.org/x/text/unicode/norm`):**
```go
norm.NFC.String("café") // Нормализованная форма
```

---

#### **8. Опасные операции**
**Изменение через указатели:**
```go
s := "hello"
bytes := []byte(s)
bytes[0] = 'H' // OK (новая память)
// unsafe-версия может привести к панике!
```

**Неверный подсчет символов:**
```go
len("€") // 3 (байта), а не 1 символ!
```

---

### **Сравнительная таблица операций**
| Операция            | Время       | Память      | Безопасность |
|---------------------|-------------|-------------|--------------|
| Конкатенация (+)    | O(n²)       | Высокая     | Да           |
| strings.Builder     | O(n)        | Низкая      | Да           |
| Преобразование []byte | O(n)      | Копия       | Да           |
| unsafe-конвертация  | O(1)        | Нет аллокации | Нет        |

---

### **Полезные ссылки**
1. [Официальная документация](https://pkg.go.dev/strings)
2. [Статья о внутренностях строк](https://go.dev/blog/strings)
3. [Оптимизации UTF-8](https://blog.golang.org/strings)

**См. также:**  
- [[Работа с файлами в Go]]  
- [[Регулярные выражения в Go]]  
- [[Сравнение string vs []byte]]  

---

### **Итоговые рекомендации**
1. Для текстовых данных всегда используйте `string`
2. Для бинарных данных — `[]byte`
3. Модификации через `strings.Builder`
4. UTF-8 обработка через `for range` или `utf8` пакет
5. Избегайте `unsafe` оптимизаций без крайней необходимости\\\