---
tags:
  - Программирование
  - Теория_по_языку_Golang
  - Основы_языка_Golang
  - map
Связанные темы:
---
# **Внутреннее устройство map в Go 1.24+**  

---

## **1. Основные изменения в Go 1.24**  
Go 1.24 представил новую реализацию мап на основе **Swiss Tables** (аналогично C++ abseil и Rust).  

### **Ключевые отличия от старых мап:**  
| Характеристика       | Go 1.23 (старая)           | Go 1.24+ (новая)           |  
|----------------------|----------------------------|----------------------------|  
| **Структура**        | Двухуровневая (бакеты + хеш-таблица) | Трехуровневая (каталог + группы + слоты) |  
| **Адресация**        | Закрытая (цепочки бакетов) | Гибридная (открытая для групп, закрытая для каталога) |  
| **Load Factor**      | 6.5/8 (81.25%)             | 7/8 (87.5%)                |  
| **Рост памяти**      | Резкие скачки (x2 + эвакуация) | Плавное увеличение (x2)    |  
| **SIMD**             | Нет                        | Да (на поддерживаемых CPU) |  

---

## **2. Новая архитектура мап**  

### **Трехуровневая структура:**  
1. **Каталог (Directory)**  
   - Хеш-таблица с закрытой адресацией.  
   - Индексируется по **старшим битам** хеша (`h1`).  
   - Содержит указатели на группы.  

2. **Группы (Groups)**  
   - Хеш-таблица с открытой адресацией (8 слотов).  
   - Использует **младшие 7 бит** хеша (`h2`) для метаданных.  
   - Оптимизирована под SIMD-сравнение.  

3. **Слоты (Slots)**  
   - Пара `ключ-значение`.  
   - Контрольный байт (`ctrl`):  
     - `0x00-0x7F`: занят (значение = `h2`),  
     - `0x80`: пуст,  
     - `0xFE`: удален (tombstone).  

```go
type hmap struct {
    count     int          // Количество элементов
    B         uint8        // Размер каталога (2^B)
    groups    unsafe.Pointer // Указатель на группы
    // ... (доп. поля для роста и seed)
}
```

---

## **3. Принцип работы**  

### **Поиск ключа:**  
1. Вычисляется хеш (`memhash`).  
2. По `h1` находится группа в каталоге.  
3. По `h2` проверяются слоты в группе (через SIMD или битовые маски).  
4. При коллизии — квадратичный пробинг.  

### **Вставка:**  
- Если `loadFactor > 7/8`, мапа растет:  
  - Создается новый каталог (x2).  
  - Данные перераспределяются **синхронно** (в отличие от старой эвакуации).  

### **Удаление:**  
- Слот помечается как `tombstone` (0xFE).  
- При последующих вставках tombstone заменяется новым значением.  

---

## **4. Отличия от старых мап**  

### **Улучшения:**  
- **Экономия памяти**:  
  - Нет `overflow`-бакетов.  
  - Выше `loadFactor` (87.5% vs 81.25%).  
- **Производительность**:  
  - SIMD-оптимизации для поиска.  
  - Меньше аллокаций при росте.  

### **Недостатки:**  
- **Резкие задержки**: Рост мапы блокирует операции записи.  
- **Нет усадки**: Память не возвращается после удаления элементов.  
- **Баг**: `map[int]int{}` и `map[int]struct{}{}` занимают одинаково.  

---

## **5. Практические выводы**  
1. **Плюсы новых мап**:  
   - Лучшая производительность для `Get` (до -35% времени).  
   - Предсказуемое потребление памяти.  
2. **Минусы**:  
   - `Put` может быть медленнее на больших мапах (до +53%).  
   - Нет гарантий времени выполнения операций.  

**Рекомендации**:  
- Используйте `make(map[K]V, size)` для предварительного выделения.  
- Для высоконагруженных сервисов тестируйте под нагрузкой.  

--- 

**Дополнительно**:  
- [Блог Go о Swiss Tables](https://go.dev/blog/swissmap)  
- [Исходный код hmap](https://github.com/golang/go/blob/master/src/runtime/map.go)